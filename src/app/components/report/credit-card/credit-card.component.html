<div class="p-grid">
    <div class="p-col-12">
        <p-toast></p-toast>
        <p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
        <h5>Credit Card Report</h5>
        <div class="card">
            <p-toolbar styleClass="p-mb-4">
                <ng-template pTemplate="left">
                   <div class="p-formgroup-inline">
                      <div class="p-field" >
                         <label for="serachSelection"  class="p-sr-only" >Report  By:</label>
                         <p-dropdown id='serachSelection' [options]="searchList" [(ngModel)]="selectedSearch" optionLabel="name" name = "search" (ngModelChange)='searchSelectChanged($event)' ></p-dropdown>
                      </div>
                      <div *ngIf="selectedSearch.name=='Day'">
                         <form [formGroup]="searchByDayForm">
                                <div class="p-input-icon-left" >
                                  <div class="p-field ">
                                     <label for="day" >Day</label>
                                     <p-calendar formControlName='Day' [minDate]="minDate" [maxDate]="maxDate" [readonlyInput]="true"  [showIcon]="true"></p-calendar>
                                  </div>
                               </div>      
                         </form>
                      </div>
                      <div *ngIf="selectedSearch.name=='Month'">
                         <form [formGroup]="searchByMonthForm">
                            <div class="p-field" >
                               <label for="month" >Month</label>
                               <p-calendar formControlName='Month' view="month"  dateFormat="mm/yy" [yearNavigator]="true" yearRange="2000:2030" [readonlyInput]="true"  [showIcon]="true"></p-calendar>
                            </div>
                         </form>
                      </div>
                      <div *ngIf="selectedSearch.name=='Date Range'">
                         <form [formGroup]="searchByDateRangeForm">
                            <div class="p-input-icon-left" >
                                <div class="p-field" >
                                    <label for="startDate" >From Date</label>
                                    <p-calendar formControlName='FromDate' [minDate]="minDate" [maxDate]="maxDate" [readonlyInput]="true" [showIcon]="true"></p-calendar>
                                </div>
                            </div>
                            <div class="p-input-icon-right">
                                <div class="p-field" >
                                    <label for="Phone">To Date</label>
                                    <p-calendar formControlName='ToDate' [minDate]="minDate" [maxDate]="maxDate" [readonlyInput]="true" [showIcon]="true"></p-calendar>
                                  </div>
                             </div>
                         </form>
                      </div>
                      <div>
                           <div class="p-field">
                              <label for="cardType" >Card Type</label>
                              <p-dropdown id='cardType' [options]="cardTypeList" [(ngModel)]="selectedCreditCard" optionLabel="name" name = "cardType" ></p-dropdown>
                           </div>
                     </div>
                      <button pButton type="button" label="Search"  icon="pi pi-search" class="p-button-primary p-mr-2 p-mb-2" type="submit" (click)="getCreditCard(false)" ></button>                      
                   </div>

                </ng-template>
                  <ng-template pTemplate="right">
                    <div class="p-d-flex">
                        <button type="button" [disabled]="showExport" pButton pRipple icon="pi pi-file-excel" (click)="exportExcel()" class="p-button-success p-mb-3 p-mr-2"  pTooltip="XLS" tooltipPosition="bottom"></button>
                        <button type="button" [disabled]="showExport" pButton pRipple icon="pi pi-file-pdf" (click)="exportPdf()" class="p-button-warning p-mb-3" pTooltip="PDF" tooltipPosition="bottom"></button>
                    </div>
                  </ng-template>
              </p-toolbar>
        </div>
        <div class="card" *ngIf="showTable">
            <p-table #dt [value]="creditCardReport" [columns]="cols" [rows]="10" [paginator]="true" resizableColumns="true" [showCurrentPageReport]="true" styleClass="p-datatable-sm"
                      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} record(s)">
                <ng-template pTemplate="header">
                    <tr>
                      <th pSortableColumn="receiptId" class="ui-resizable-column" pResizableColumn width="10%" >
                            Transaction#
                            <p-columnFilter class="table-header-left" type="text" field="receiptId" display="menu"></p-columnFilter>  
                      </th>
                      <th pSortableColumn="transactionDate" class="ui-resizable-column" pResizableColumn width="15%" >
                            Date
                            <p-columnFilter class="table-header-left" type="text" field="transactionDate" display="menu"></p-columnFilter>  
                    </th>
                    <th pSortableColumn="billableName" class="ui-resizable-column" pResizableColumn width="15%" >
                            Name
                            <p-columnFilter class="table-header-left" type="text" field="billableName" display="menu"></p-columnFilter>  
                    </th>
                      <th pSortableColumn="creditCardNumber" class="ui-resizable-column" pResizableColumn width="15%" >
                           Card Number
                           <p-columnFilter class="table-header-left" type="text" field="creditCardNumber" display="menu"></p-columnFilter>  
                      </th>
                      <th pSortableColumn="authCode" class="ui-resizable-column" pResizableColumn width="10%" >
                          Auth Code
                          <p-columnFilter class="table-header-left" type="text" field="authCode" display="menu"></p-columnFilter>  
                      </th>
                      <th pSortableColumn="transactionType" class="ui-resizable-column" pResizableColumn width="10%" >
                        Type
                        <p-columnFilter class="table-header-left" type="text" field="transactionType" display="menu"></p-columnFilter>  
                    </th>
                      <th pSortableColumn="paymentStatus" class="ui-resizable-column" pResizableColumn width="10%" >
                          Status
                          <p-columnFilter class="table-header-left" type="text" field="paymentStatus" display="menu"></p-columnFilter>  
                      </th>
                      <th pSortableColumn="amount" class="ui-resizable-column" pResizableColumn width="15%" style="text-align:center">
                          Amount
                          <p-columnFilter class="table-header-left" type="text" field="amount" display="menu"></p-columnFilter> 
                      </th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                    <tr class="maxTableRow">
                    <td>
                       {{item.receiptId}}
                    </td>
                  
                    <td>
                       {{item.transactionDate }}
                    </td>
                    <td>
                      {{item.billableName}}
                    </td>

                    <td>
                        {{item.cardType}}-{{item.creditCardNumber}}
                    </td>
                    <td>
                      {{item.authCode}}
                   </td>
                   <td>
                    {{item.transactionType}}
                 </td>
                    <td>
                      {{item.paymentStatus}}
                     </td>                  
                    <td style="text-align:right" *ngIf="item.amount>=0">
                       {{item.amount | currency}}
                    </td>  
                    <td style="text-align:right" *ngIf="item.amount<0">
                        ({{item.amount*-1 | currency}})
                     </td>                      
                    </tr>
                </ng-template>
                <ng-template pTemplate="footer">
                  <tr>
                      <td colspan="6"></td>
                      <td>Approved Total</td>
                      <td *ngIf="totalApproved>=0">{{totalApproved | currency}}</td>
                      <td *ngIf="totalApproved <0" >({{totalApproved*-1 | currency}})</td>
                  </tr>
                  <tr>
                    <td colspan="6"></td>
                    <td>Declined Total</td>
                    <td *ngIf="totalDeclined>=0">{{totalDeclined | currency}}</td>
                    <td *ngIf="totalDeclined <0" >({{totalDeclined*-1 | currency}})</td>
                </tr>
              </ng-template>
            </p-table>
        </div>
        <div class="card" *ngIf="showReport">
          <tr-viewer #glReportViewer
          [containerStyle]="viewerContainerStyle"
          [serviceUrl]="reportApiUrl"
          [reportSource]="{
              report: 'CreditCardReport.trdx',
              parameters: { 
                Url:maxApiUrl, 
                token: authService.currentUserValue.token,
                tenantid:authService.currentUserValue.tenantId,
                cardType: selectedCreditCard.code,
                searchBy: selectedSearch.name
              }
          }"
          [viewMode]="'INTERACTIVE'"
          [scaleMode]="'FIT_PAGE_WIDTH'"
          [ready]="ready"
          [viewerToolTipOpening]="viewerToolTipOpening"
          [enableAccessibility]="false"            
          [scale]="1.0">
      </tr-viewer>
      </div>
    </div>
</div>